
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<script type="text/javascript">
console.log("=== START ===")

window.onload = function() {
    var s = ""
    if (window.PublicKeyCredential) {
        s = "supported.";
    } else {
        s = "not supported.";
    }
    messageArea.innerHTML = "PublicKeyCredential " + s

};
    
    function addMessage(message) {
        messageArea.innerHTML += "<br>" + message
    }

    function addMessageNoBR(message) {
        messageArea.innerHTML += message
    }

    function test02() {
        addMessage("navigator   : " + navigator)
        addMessage("credentials : " + navigator.credentials)
        addMessage("credentials : " + navigator.credentials)
        
        var publicKey = {
            challenge: new Uint8Array([21,31,105]),
            rp: { name: "ACME Corporation" },
            user : {
                id: Uint8Array.from(window.atob("MIIBkzCCATigAwIBAjCCAZMwggE4oAMCAQIwggGTMII="), c=>c.charCodeAt(0)),
                name: "alex.mueller@example.com",
                displayName : "Alex Mueller",
            },
            pubKeyCredParams: [
                {
                    type: "public-key",
                    alg: -7
                }
            ],
        }

        addMessageNoBR("<h4>publicKey   : " + publicKey + "</h4>")
        addMessageNoBR("challenge   : " + publicKey.challenge)
        addMessage("rp.name          : " + publicKey.rp.name)

        //
        navigator.credentials.create ({publicKey})
        .then ( function (newCredentialInfo) {
            addMessage("*1*");
            addMessage("newCredentialInfo : " + newCredentialInfo)
            addMessage("  id : " + newCredentialInfo.id)
        }).catch( function (err) {
            addMessage("err : " + err);

        });
    }
    
    
function test01() {
    console.log("=== START test01 ===");
    message.innerHTML += "<br>KKKK";
    if (!window.PublicKeyCredential) { /* Client not capable. Handle error. */ }

    var publicKey = {
      // The challenge is produced by the server; see the Security Considerations
      challenge: new Uint8Array([21,31,105 /* 29 more random bytes generated by the server */]),

      // Relying Party:
      rp: {
        name: "ACME Corporation"
      },

      // User:
      user: {
        id: Uint8Array.from(window.atob("MIIBkzCCATigAwIBAjCCAZMwggE4oAMCAQIwggGTMII="), c=>c.charCodeAt(0)),
        name: "alex.mueller@example.com",
        displayName: "Alex Müller",
      },

      // This Relying Party will accept either an ES256 or RS256 credential, but
      // prefers an ES256 credential.
      pubKeyCredParams: [
        {
          type: "public-key",
          alg: -7 // "ES256" as registered in the IANA COSE Algorithms registry
        },
        {
          type: "public-key",
          alg: -257 // Value registered by this specification for "RS256"
        }
      ],

      authenticatorSelection: {
        // Try to use UV if possible. This is also the default.
        userVerification: "preferred"
      },

      timeout: 360000,  // 6 minutes
      excludeCredentials: [
        // Don’t re-register any authenticator that has one of these credentials
        {"id": Uint8Array.from(window.atob("ufJWp8YGlibm1Kd9XQBWN1WAw2jy5In2Xhon9HAqcXE="), c=>c.charCodeAt(0)), "type": "public-key"},
        {"id": Uint8Array.from(window.atob("E/e1dhZc++mIsz4f9hb6NifAzJpF1V4mEtRlIPBiWdY="), c=>c.charCodeAt(0)), "type": "public-key"}
      ],

      // Make excludeCredentials check backwards compatible with credentials registered with U2F
      extensions: {"appidExclude": "https://acme.example.com"}
    };

    // Note: The following call will cause the authenticator to display UI.
    navigator.credentials.create({ publicKey })
      .then(function (newCredentialInfo) {
        // Send new credential info to server for verification and registration.
      }).catch(function (err) {
        // No acceptable authenticator or user refused consent. Handle appropriately.
      });
      console.log("--- END test01 ---");
}




    /*
const options = {
    publicKey: {
        rp: { name: "example.com"},
        user: {
            name: "john.appleseed@example.com",
            id: "aaaaaaaa",  // userIdBuffer,
            displayName: "John Appleseed"
        },
        publicKeyCredParams: [ { type: "public-key", alg: -7 } ],
        challenge: "bbbbbbbb",  // challengeBuffer,
        authenticatorSelection: { authenticatorAttachment: "platform" },
        attestation: "direct"
    }
};
    
console.log(options)

//const publicKeyCredential = await navigator.credentials.create({options})
//console.log(publicKeyCredential)

navigator.credentials.create({ options })
    */

/*
const isAvailable = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();

if (isAvailable) {
    console.log("OK");
} else {
    console.log("NG");
}
*/
//navigator.credentials.create()

//navigator.credentials.get()

console.log("--- END ---")

function doRegistration(){
    //alert('Click');
    test02();
}

</script>
</head>
<body>
<h1>WebAuthentication API 2</h1>

<input type="button" value="Registration" onclick="doRegistration()">

<h2>Log</h2>
<div id=messageArea>
Hello
</div>
    
    
</body>
</html>
